build_platforms:
  - name: windows
    type: Unity::VM
    image: sdet/burst-devimage:stable
    flavor: b1.large
    npm_cmd: "npm"
    upm_cmd: "upm-ci"
  - name: linux
    image: sdet/burst_linux:stable
    type: Unity::VM
    flavor: b1.large
    npm_cmd: "sudo npm"
    upm_cmd: "DISPLAY=:0.0 upm-ci"
  - name: macOS
    image: burst/burst_mac:stable
    type: Unity::VM::osx
    flavor: m1.mac
    npm_cmd: "npm"
    upm_cmd: "upm-ci"


editor_versions:
  - version: "2018.4"
  - version: "2019.2"
  - version: "2019.3"
  - version: "trunk"
---

{% for editor in editor_versions %}
{% for platform in build_platforms %}
{% unless platform.name == "linux" %}
run_tests_on_mono_{{platform.name}}_{{editor.version}}:
  name: Tests upm-ci on {{platform.name}}
  agent:
      name: {{platform.name}}
      type: {{platform.type}}
      image: {{platform.image}}
      flavor: {{platform.flavor}}
  commands:
    - {{platform.npm_cmd}} install upm-ci-utils@stable --registry https://api.bintray.com/npm/unity/unity-npm -g
    - {{platform.upm_cmd}} package pack --package-path src/
    - {{platform.upm_cmd}} project test --project-path Unity.Mathematics.TestProject --unity-version {{editor.version}} --type project-tests
{% endunless %}
{% endfor %}
{% endfor %}

validate_package_minimal:
  name: Validate Package Linux Minimal
  agent:
    name: linux
    image: sdet/burst_linux:stable
    type: Unity::VM
    flavor: b1.large
  commands:
    - sudo npm install upm-ci-utils@stable --registry https://api.bintray.com/npm/unity/unity-npm -g
    - DISPLAY=:0.0 upm-ci package pack --package-path src/
    - DISPLAY=:0.0 upm-ci package test --package-path src/ --unity-version 2019.1
  artifacts:
    packages:
      paths:
        - "upm-ci~/packages/**/*"
  dependencies:
    {% for editor in editor_versions %}
    {% for platform in build_platforms %}
    {% unless platform.name == "linux" %}
    - .yamato/upm-ci.yml#run_tests_on_mono_{{platform.name}}_{{editor.version}}
    {% endunless %}
    {% endfor %}
    {% endfor %}

  {% for platform in build_platforms %}
  {% for editor in editor_versions %}
validate_package_{{platform.name}}_{{editor.version}}:
  name: Validate package {{platform.name}} {{editor.version}}
  agent:
    name: {{platform.name}}
    image: {{platform.image}}
    type: {{platform.type}}
    flavor: {{platform.flavor}}
  commands:
    - {{platform.npm_cmd}} install upm-ci-utils@stable --registry https://api.bintray.com/npm/unity/unity-npm -g
    - {{platform.upm_cmd}} package pack --package-path src/
    - {{platform.upm_cmd}} package test --package-path src/ --unity-version {{ editor.version }}
  artifacts:
    packages_{{platform.name}}_{{editor.version}}:
      paths:
        - "upm-ci~/packages/**/*"
    results_{{platform.name}}_{{editor.version}}:
        paths:
            - "upm-ci~/**/*"
  dependencies:
    {% for platform in build_platforms %}
    {% unless platform.name == "linux" %}
    - .yamato/upm-ci.yml#run_tests_on_mono_{{platform.name}}_{{editor.version}}
    {% endunless %}
    {% endfor %}
  {% endfor %}
  {% endfor %}


publish:
  name: Publish
  agent:
    type: Unity::VM
    image: package-ci/win10:stable
    flavor: m1.large
  commands:
    - npm install upm-ci-utils@stable --registry https://api.bintray.com/npm/unity/unity-npm -g
    - upm-ci package publish --package-path src/
  artifacts:
    packages:
      paths:
        - "upm-ci~/packages/**/*"
  dependencies:
   - .yamato/upm-ci.yml#validate_package_minimal


promote:
  name: Promote
  agent:
    type: Unity::VM
    image: package-ci/win10:stable
    flavor: m1.large
  variables:
    UPMCI_PROMOTION: 1
  commands:
    - npm install upm-ci-utils@stable --registry https://api.bintray.com/npm/unity/unity-npm -g
    - upm-ci package promote --package-path src/
  artifacts:
    packages:
      paths:
        - "upm-ci~/packages/**/*"
  dependencies:
    - .yamato/upm-ci.yml#publish


publish_ci:
  name: all Publish Pipeline
  triggers:
    tags:
      only:
        - /^\d+\.\d+\.\d+(-preview(\.\d+)?)?$/
  dependencies:
    - .yamato/upm-ci.yml#publish

nightly_ci:
  name: all Nightly Pipeline
  triggers:
    recurring:
      - branch: master
        frequency: daily
  dependencies:
    {% for platform in build_platforms %}
      {% for editor in editor_versions %}
      - .yamato/upm-ci.yml#validate_package_{{platform.name}}_{{editor.version}}
      {% endfor %}
    {% endfor %}


commit_ci:
  name: all CI pipeline
  triggers:
    branches:
      only:
        - "/.*/"
  dependencies:
    - .yamato/upm-ci.yml#validate_package_minimal
